### 前言

KubeMin-Cli 是一个基于云原生的PaaS平台，以轻量化工作流的方式来描述应用，结构模型基于 **OAM(Open Application Model)**，原生设计的工作流作为核心驱动应用的完整生命周期：初始化资源，创建/更新工作负载，发布事件，监听状态……

KubeMin-Cli中有两个核心能力：

1.**Traits：可组合的能力原子**

Traits结构将Kubernetes中的Pod，Service,Volume等底层概念抽象化，将存储，容器边车，环境变量，初始化，密钥……以Traits的方式定义，使组件不再依赖复杂的Yaml，而是用组合的方式来构建复杂应用。还提供了“引入模版”功能，能快速创建多个相同形态的新应用（如多套 MySQL）,以此来保证生成的资源可用，无冲突，可追溯。

2.**Workflow:任务驱动的应用生命周期**

每次“部署”“更新”“扩缩容”等操作都被抽象成一条工作流实例：支持并行任务，支持状态一致性，支持人物间依赖，支持重试，支持持久化执行记录等……
使用List_watch模式来维护应用状态的整个生命周期。



### 架构图





### OAM Traits (特征)

#### Storage 存储

##### **存储类型详解**

| **type**     | **对应 Kubernetes 资源**            | 说明                                                         |
| ------------ | ----------------------------------- | ------------------------------------------------------------ |
| persistent   | PersistentVolumeClaim + VolumeMount | 稳定的存储，使用`PersistentVolumeClaim`卷用于将持久卷(PersistentVolume)挂载到Pod中。这种方式可以为Pod提供一个**稳定的存储方式，不会因为重启/Pod崩溃而丢失容器内持久化存储的文件**。 |
| ephemeral    | emptyDir + VolumeMount              | 临时存储，对于定义了 `emptyDir` 卷的 Pod，在 Pod 被指派到某节点时此卷会被创建。 就像其名称所表示的那样，`emptyDir` 卷最初是空的。尽管 Pod 中的容器挂载 `emptyDir` 卷的路径可能相同也可能不同，但这些容器都可以读写 `emptyDir` 卷中相同的文件。 当 Pod 因为某些原因被从节点上删除时，`emptyDir` 卷中的数据也会被**永久删除**。 |
| ~~hostPath~~ | ~~hostPath + VolumeMount~~          | hostPath 可以让**主机节点文件系统上的文件或目录挂载到Pod中**，比如运行一个需要访问节点级系统组件的容器；让存储在主机系统上的配置文件可以被[静态 Pod](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/static-pod/) 以只读方式访问。<br />这种方式存在许多安全风险，所以系统中不支持。 |
| config       | ConfigMap + VolumeMount 或 EnvFrom  | ConfigMap 对象中存储的数据可以被 `configMap` 类型的卷引用，然后被 Pod 中运行的容器化应用使用。<br />但是：1.你必须先[创建 ConfigMap](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/#create-a-configmap)， 才能使用它。2.ConfigMap 总是以 `readOnly` 的模式挂载。3.某容器以 [`subPath`](https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/#using-subpath) 卷挂载方式使用 ConfigMap 时， 若 ConfigMap 发生变化，此容器将无法接收更新。4.文本数据挂载成文件时采用 UTF-8 字符编码。如果使用其他字符编码形式，可使用 `binaryData` 字段。 |
| secret       | Secret + VolumeMount 或 EnvFrom     | `secret` 卷用来给 Pod 传递敏感信息，例如密码。你可以将 Secret 存储在 Kubernetes API 服务器上，然后以文件的形式挂载到 Pod 中，无需直接与 Kubernetes 耦合。 <br />但是：1.使用前你必须在 Kubernetes API 中创建 Secret。2.Secret 总是以 `readOnly` 的模式挂载。 3.容器以 [`subPath`](https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/#using-subpath) 卷挂载方式使用 Secret 时，将无法接收 Secret 的更新。 |

##### **字段详解**

| 字段       | 类型   | 限制 | 默认值        | 说明                                                         |
| ---------- | ------ | ---- | ------------- | ------------------------------------------------------------ |
| name       | string | 必填 | -             | 存储卷的唯一名称标识符，用于生成 Kubernetes Volume 名称。必须符合 DNS-1123 子域名规范（小写字母、数字、连字符）。 |
| type       | string | 必填 | -             | 存储类型，决定底层 Kubernetes 资源类型。支持的值见上列 [存储类型](#存储类型) 章节。 |
| mountPath  | string | 必填 | `/mnt/<name>` | 容器内挂载路径。若未指定，默认为 `/mnt/<volume-name>`。      |
| subPath    | string | 可选 | `""`          | 挂载 Volume 内的子路径。用于将同一 Volume 的不同子目录挂载到不同位置。 |
| readOnly   | bool   | 可选 | `false`       | 是否以只读模式挂载。设置为 `true` 时容器无法写入该挂载点。   |
| sourceName | string | 可选 | `name`        | 仅用于 ConfigMap/Secret 类型。指定实际 ConfigMap 或 Secret 资源的名称。若为空，则使用 `name` 字段的值。 |
| size       | string | 可选 | `"1Gi"`       | PVC 请求的存储容量。格式遵循 Kubernetes 资源量规范（如 `5Gi`、`100Mi`）。 |

持久化存储专用字段，即下列字段仅在`type: "persistent"` 时生效：

| 字段         | 类型   | 限制 | 默认值  | 说明                                                         |
| ------------ | ------ | ---- | ------- | ------------------------------------------------------------ |
| tmpCreate    | bool   | 可选 | `false` | **是否使用模式控制**：<br/>• `true`：动态创建新的 PVC，PVC 名称格式为 `pvc-<name>-<appID>`<br/>• `false`：引用已存在的 PVC(默认模式) |
| claimName    | string | 可选 |         | 预留字段，**当前代码未实现**。Volume 引用的 PVC 名称由 `TmpCreate` 决定：为 `true` 时使用生成名称，为 `false` 时使用 `name` 字段。 |
| storageClass | string | 可选 |         | 指定 PVC 使用的 StorageClass。若为空，使用集群默认 StorageClass。 |
|              |        |      |         |                                                              |

##### **逻辑详解**

1.当 `type="persistent"` 时，系统**始终会创建 PVC 对象**，但根据 `tmpCreate` 字段决定命名和注解：

1.1 tmpCreate = true（模板创建模式）使用volumeClaimTemplates的方式自动创建PVC

```yaml
volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      creationTimestamp: null
      name: data
```

添加注解：`storage.kubemin.cli/pvc-role: template`;Volume 引用动态生成的 PVC 名称;

适用场景：需要为每个应用实例创建独立存储



1.2 tmpCreate = false（直接创建模式）

直接使用 `name` 字段作为 PVC 名称;创建基础 PVC 对象（无特殊注解）;Volume 引用该 PVC 名称;

适用场景：多个应用共享同一存储，或需要精确控制 PVC 名称



##### **使用示例**

###### 动态创建持久化存储

```json
{
  "storage": [
    {
      "type": "persistent",
      "name": "mysql-data",
      "mountPath": "/var/lib/mysql",
      "tmpCreate": true,
      "size": "10Gi",
      "storageClass": "fast-ssd"
    }
  ]
}
```

**生成结果**：

- PVC 名称：`pvc-mysql-data-<appID>`
- Volume 类型：`PersistentVolumeClaim`
- 挂载路径：`/var/lib/mysql`



###### 直接创建pvc

```json
{
  "storage": [
    {
      "type": "persistent", //使用稳定存储类型
      "name": "shared-data",
      "mountPath": "/data", //挂载目录(可选)，如果为空挂载到默认的目录下
      "size": "5Gi", //存储大小
      "TmpCreate": false
    }
  ]
}
```

**生成结果**：

- 创建名为 `shared-data` 的 PVC（名称不带 appID 后缀）
- Volume 类型：`PersistentVolumeClaim`
- 适用于多应用共享同一 PVC 的场景



###### 临时存储

```json
{
  "storage": [
    {
      "type": "ephemeral",
      "name": "cache",
      "mountPath": "/tmp/cache"
    }
  ]
}
```

**生成结果**：

- Volume 类型：`EmptyDir`
- Pod 删除后数据丢失



###### ConfigMap 挂载

```json
{
  "storage": [
    {
      "type": "config",
      "name": "app-config",
      "sourceName": "my-configmap",
      "mountPath": "/etc/config",
      "readOnly": true
    }
  ]
}
```

**生成结果**：

- 挂载名为 `my-configmap` 的 ConfigMap
- 默认文件权限：`0644`

备注：

```
0644 是 Unix/Linux 的文件权限模式，分为三组：
0644
│││└── 其他用户 (Others): 4 = r-- (只读)
││└─── 同组用户 (Group):  4 = r-- (只读)
│└──── 文件所有者 (Owner): 6 = rw- (读写)
└───── 特殊位 (无)
```



###### Secret 挂载

```json
{
  "storage": [
    {
      "type": "secret",
      "name": "certs",
      "sourceName": "tls-secret",
      "mountPath": "/etc/ssl/certs",
      "readOnly": true
    }
  ]
}
```

**生成结果**：

- 挂载名为 `tls-secret` 的 Secret
- 默认文件权限：`0644`



###### SubPath 挂载

```json
{
  "storage": [
    {
      "type": "persistent",
      "name": "data",
      "mountPath": "/var/lib/mysql",
      "subPath": "mysql",
      "TmpCreate": true,
      "size": "5Gi"
    }
  ]
}
```

**生成结果**：

- 仅挂载 PVC 中的 `mysql` 子目录到 `/var/lib/mysql`
- 同一 PVC 可被多个容器以不同 subPath 挂载



###### 多容器共享存储

```
{
  "storage": [
    {
      "type": "persistent",
      "name": "shared-data",
      "mountPath": "/data",
      "TmpCreate": true,
      "size": "5Gi"
    }
  ],
  "init": [
    {
      "name": "init-data",
      "properties": {
        "image": "busybox:latest"
      },
      "traits": {
        "storage": [
          {
            "type": "ephemeral",
            "name": "shared-data",
            "mountPath": "/init-data"
          }
        ]
      }
    }
  ],
  "sidecar": [
    {
      "name": "backup",
      "image": "backup-agent:v1",
      "traits": {
        "storage": [
          {
            "type": "ephemeral",
            "name": "shared-data",
            "mountPath": "/backup-source",
            "readOnly": true
          }
        ]
      }
    }
  ]
}
```

**说明**：

- 主容器声明 `type: persistent` 并设置 `TmpCreate: true`，系统创建 PVC

- Init/Sidecar 使用 `type: ephemeral` + 相同的 `name` 声明挂载意图

- 系统会自动去重：同名 Volume 只创建一次，各容器的 VolumeMount 独立配置

- 各容器可使用不同的 `mountPath` 和 `readOnly` 设置

  

> **注意**：如果 Init/Sidecar 也使用 `type: persistent`，由于 `TmpCreate` 默认为 `false`，会尝试创建额外的同名 PVC，导致资源冲突或创建多余对象。

##### 注意事项

1. **名称规范**：`name` 字段必须符合 Kubernetes DNS-1123 子域名规范，系统会自动进行规范化处理（小写化、移除非法字符）

2. **PVC 生命周期**：动态创建的 PVC（`TmpCreate: true`）生命周期与应用绑定，删除应用时需考虑 PVC 清理策略

3. **StorageClass**：确保指定的 StorageClass 在目标集群中存在，否则 PVC 将处于 Pending 状态

4. **SubPath 与空目录**：使用 `subPath` 时，如果子目录不存在，Kubernetes 不会自动创建，可能导致挂载失败

5. **只读模式**：对于 ConfigMap 和 Secret 类型，建议始终设置 `readOnly: true`

6. **Volume 去重**：当多个容器（主容器、Init、Sidecar）声明同名存储时，系统只创建一个 Volume，但各自的 VolumeMount 独立配置

7. **多容器共享存储**：Init/Sidecar 容器共享主容器的 PVC 时，应使用 `type: ephemeral` 声明挂载意图，避免重复声明 `type: persistent` 导致创建多余的 PVC 对象

8. **claimName 字段**：该字段当前未实现，请勿依赖此字段指定已存在的 PVC 名称

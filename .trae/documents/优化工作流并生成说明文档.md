## 目标

* 优化现有工作流的并发控制、可观测性与稳健性，不改变业务语义。

* 生成中文说明文档（doc/workflow\.md）阐述架构、改动原因与收益、配置使用方法。

## 问题诊断

* 并发控制仅对顺序步骤有限制（SequentialMaxConcurrency），并行步骤在同一优先级下会无上限地并行执行，存在资源突增的风险。

* 步骤级可观测性不足：有工作流级和 Job 级 span，但缺少步骤级 span，难以定位瓶颈与失败位置。

* 队列与工人协作的错误上报未充分利用 errChan，错误仅日志记录，难以在上层统一处理。

## 优化方案

1. 并行并发上限

* 在 `config.WorkflowRuntimeConfig` 中新增 `ParallelMaxConcurrency` 字段和命令行参数 `--workflow-parallel-max-concurrency`。

* 在 `pkg/apiserver/event/workflow/workflow.go` 的 `determineStepConcurrency` 增加并行上限参数；并在 `Run` 中使用 `w.Cfg.Workflow.ParallelMaxConcurrency` 限速。

* 效果：避免并行步骤在高优先级下同时创建过多资源造成集群压力；更稳定、更可控。

1. 步骤级可观测性

* 在 `WorkflowCtl.Run` 内，围绕每个 `StepExecution` 创建步骤级 OTel span（名称含 step 名称与优先级），并将上下文传递到 `job.RunJobs`。

* 效果：定位性能瓶颈和失败位置更快；便于监控和追踪。

1. 错误上报通道

* 在 `StartWorker` 与 `Dispatcher` 中对于无法恢复的错误（例如反复读取队列失败）通过 `errChan` 汇报一次性错误事件；保留现有日志。

* 效果：允许上层统一治理错误（报警/降级/重启策略）。

1. 文档交付

* 在 `doc/workflow.md` 编写中文说明，覆盖：

  * 架构总览与数据流（本地执行与队列模式）

  * 并发模型（顺序/并行、优先级桶、并发上限）

  * 队列分发与工人处理（AutoClaim、ACK、失败路径）

  * 可观测性（工作流/步骤/Job 级追踪与日志）

  * 改动说明与收益（为何更改、风险与取舍）

  * 配置项与命令行参数

  * 常见问题与运维建议

## 影响范围

* 代码文件：

  * `pkg/apiserver/config/config.go`（新增字段、校验、flag）

  * `pkg/apiserver/event/workflow/workflow.go`（并发计算与步骤 span）

  * 可选：`StartWorker`、`Dispatcher` 使用 `errChan` 上报不可恢复错误

* 不改变现有存储模型与消息负载格式；无数据库迁移。

## 风险控制

* 默认值保持与当前行为一致（并行上限默认等于任务数或设置为一个温和的上限如 8）。

* 所有更改仅添加参数与注释，逻辑改动可回滚；加入编译与基础运行验证。

## 验证

* 执行 `go build ./...` 确认编译通过。

* 运行本地模式与队列模式基本路径测试（简单工作流、并行/顺序混合）。

* 验证 Jaeger/OTel 中能看到步骤级 span。

## 交付物

* 代码优化（并发上限、步骤级追踪、错误上报）

* `doc/workflow.md` 中文说明文档，包含改动原因与收益、配置说明与使用指南。

## 后续可选增强（不在本次改动中）

* 步骤级错误策略（继续/中止）与 Job 级重试策略统一配置化。

* 队列消息的死信通道与重试计数（需要扩展 Queue 接口或消息元数据）。

